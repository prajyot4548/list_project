<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Banking Support - Home</title>

  <!-- ALL CSS MERGED INSIDE STYLE (OPTION A) -->
  <style>

  /* =====================================================
     style.css ‚Äì EXACT MATCH OF YOUR DESIGN
     ‚Ä¢ Google Font: Roboto
     ‚Ä¢ Red-Orange gradients (ff6a00 ‚Üí ee0979)
     ‚Ä¢ Pill buttons, smooth animations
     ‚Ä¢ Filter modal, solution cards, chatbot
     ‚Ä¢ 100% responsive
     ===================================================== */

  /* ---------------- IMPORT FONT ---------------- */
  @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap');

  /* ---------------- RESET ---------------- */
  *,
  *::before,
  *::after {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  /* ---------------- BODY ---------------- */
  body {
    font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    color: #333;
    line-height: 1.6;
    padding: 20px;
    min-height: 100vh;
  }

  /* ---------------- LOGIN PAGE ---------------- */
  .login-body {
    margin: 0;
    height: 100vh;
    width: 100%;
    background: url("background.png") no-repeat center center / cover;
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    font-family: "Segoe UI", sans-serif;
  }

  .login-container {
    background: rgba(0, 0, 0, 0.7);
    padding: 30px;
    border-radius: 15px;
    width: 350px;
    text-align: center;
    box-shadow: 0px 0px 20px rgba(0, 0, 0, 0.5);
    color: white;
  }

  .login-container h1 {
    margin-bottom: 20px;
    font-size: 22px;
  }

  .input-group {
    text-align: left;
    margin-bottom: 15px;
  }

  .input-group label {
    display: block;
    margin-bottom: 5px;
  }

  .input-group input {
    width: 100%;
    padding: 10px;
    border: none;
    border-radius: 8px;
    outline: none;
  }

  .btn {
    width: 100%;
    padding: 12px;
    background: linear-gradient(90deg, #ff6a00, #ee0979);
    border: none;
    border-radius: 8px;
    color: #fff;
    font-size: 16px;
    cursor: pointer;
    transition: 0.3s;
  }

  .btn:hover {
    background: linear-gradient(90deg, #ee0979, #ff6a00);
  }

  .footer-text {
    margin-top: 15px;
    font-size: 13px;
    color: #ccc;
  }

  /* ---------------- HOME PAGE ---------------- */
  .home-body {
    background: #f9f9f9;
    color: #333;
    min-height: 100vh;
  }

  .navbar {
    background: #2c3e50;
    padding: 15px 50px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .logo {
    color: #fff;
    font-weight: 700;
    font-size: 1.4rem;
  }

  .navbar ul {
    list-style: none;
    display: flex;
    gap: 20px;
  }

  .navbar ul li a {
    color: #fff;
    text-decoration: none;
    font-weight: bold;
    font-size: 1rem;
    transition: opacity .2s;
  }

  .navbar ul li a:hover {
    opacity: 0.8;
    text-decoration: underline;
  }

  .hero {
    padding: 40px 20px;
    background: linear-gradient(135deg, #3498db, #2c3e50);
    color: white;
    border-radius: 0 0 40px 40px;
    text-align: center;
  }

  .hero h1 {
    font-size: 40px;
    margin-bottom: 20px;
    font-weight: 700;
  }

  .hero p {
    font-size: 18px;
    margin-bottom: 30px;
    opacity: 0.9;
  }

  footer {
    text-align: center;
    padding: 15px;
    margin-top: 30px;
    background: #2c3e50;
    color: white;
    border-radius: 20px 20px 0 0;
    font-size: 0.9rem;
  }

  /* ---------------- FILTER BUTTONS ---------------- */
  #toggleFilter,
  #toggleDisplayField {
    display: block;
    margin: 20px auto;
    padding: 12px 24px;
    background: linear-gradient(135deg, #4A90E2 0%, #50C878 100%);
    color: white;
    border: none;
    border-radius: 50px;
    font-size: 16px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 5px 15px rgba(74, 144, 226, 0.2);
  }

  #toggleFilter:hover,
  #toggleDisplayField:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(74, 144, 226, 0.3);
    background: linear-gradient(135deg, #357ABD 0%, #3DAF6A 100%);
  }

  /* ---------------- FILTER MODAL ---------------- */
  .filter-section,
  .field-filter-section {
    margin: 20px auto;
    width: 90%;
    max-width: 800px;
    background: #fff;
    padding: 30px;
    border-radius: 15px;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
    animation: slideInDown 0.5s ease-out;
  }

  @keyframes slideInDown {
    from {
      opacity: 0;
      transform: translateY(-20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* ---------------- PROBLEM & SOLUTION ---------------- */
  .problem-section,
  .solution-section {
    margin: 40px auto;
    width: 80%;
    max-width: 1100px;
    background: #fff;
    padding: 25px;
    border-radius: 15px;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
  }

  /* ---------------- RESPONSIVE ---------------- */
  @media (max-width: 768px) {
    .navbar {
      padding: 15px 20px;
      flex-direction: column;
      gap: 10px;
    }

    .hero h1 {
      font-size: 32px;
    }

    .problem-section,
    .solution-section {
      width: 95%;
    }

    .filter-section,
    .field-filter-section {
      width: 95%;
      padding: 20px;
    }
  }

  </style>
</head>

<body class="home-body">

  <header class="navbar">
    <h2 class="logo">Banking Support</h2>
    <nav>
      <ul>
        <li><a href="home.html">Home</a></li>
        <li><a href="index.html">Logout</a></li>
      </ul>
    </nav>
  </header>

  <section class="hero">
    <img src="/static/List.png" class="logo" style="height:60px;">
    <center>
      <h1>List Software Support Team</h1>
      <p>Submit your issue, and we‚Äôll find the best solution for you.</p>
    </center>
  </section>

<script>
document.addEventListener("DOMContentLoaded", () => {

  const toggleFilterBtn = document.getElementById("toggleFilter");
  const filterSection = document.getElementById("filters");
  const filterForm = document.getElementById("filterForm");
  const problemForm = document.getElementById("problemForm");
  const solutionBox = document.getElementById("solutionBox");
  const displayOptions = document.querySelectorAll(".displayOption");

  document.getElementById("exportCsvBtn").addEventListener("click", () => exportToCSV());
  document.getElementById("exportPdfBtn").addEventListener("click", () => exportToPDF());

  let lastFilterData = {};
  let lastProblem = "";
  let lastTickets = [];

  function getCallId(t) {
    return t["√Ø¬ª¬øCALL_ID"] || t.CALL_ID || "";
  }

  let dateSortAsc = true;
  window.isSorting = false;

  toggleFilterBtn.addEventListener("click", () => {
    filterSection.style.display =
      filterSection.style.display === "none" || !filterSection.style.display
        ? "block"
        : "none";
  });

  function parseCallDate(str) {
    if (!str) return null;

    let d = new Date(str);
    if (!isNaN(d)) return d;

    const m = str.match(/(\d{2})-(\d{2})-(\d{4})/);
    if (m) {
      const mm = m[1];
      const dd = m[2];
      const yyyy = m[3];
      const iso = `${yyyy}-${mm}-${dd}`;
      d = new Date(iso);
      if (!isNaN(d)) return d;
    }
    return null;
  }

  filterForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    const programText =
      document.getElementById("programFilter").value?.trim() || "";

    let programNumber = "";
    if (programText) {
      const match = programText.match(/- *(\d+)/);
      programNumber = match
        ? match[1]
        : programText.replace(/\D/g, "");
    }

    const filters = {
      fromDate: document.getElementById("dateFilter").value || "",
      toDate: document.getElementById("callIdFilter").value || "",
      bankName: document.getElementById("bankNameFilter").value?.trim() || "",
      ticketId: document.getElementById("ticketIdFilterInput").value?.trim() || "",
      problem:
        cleanProblemText(
          document.getElementById("problemInput").value?.trim()
        ) || "",
      product: document.getElementById("productFilter").value?.trim() || "",
      program: programNumber || ""
    };

    lastFilterData = filters;
    await fetchSolutions(filters.problem, filters);
  });

  function cleanProblemText(text) {
    if (!text) return "";

    text = text.trim().toLowerCase();
    text = text.replace(/[^\w\s]/g, " ");
    text = text.replace(/\s+/g, " ");

    let words = text.split(" ");

    const stopWords = [
      "the","is","are","and","or","for","please","need","problem","issue","not",
      "working","want","cannot","can't","from","to","in","on","how","fix","wrong",
      "with","facing","having","when","while","this","that","user","getting",
      "after","before","but","still","then"
    ];

    words = words.filter(w => !stopWords.includes(w));
    words = [...new Set(words)];

    if (words.length > 10) words = words.slice(0, 10);

    return words.join(" ");
  }

  problemForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    let problemText = cleanProblemText(
      document.getElementById("problemInput").value.trim()
    );

    if (!problemText || problemText.length < 2) {
      alert("Please enter a valid problem.");
      return;
    }

    lastProblem = problemText;
    const tempFilters = { ...lastFilterData, problem: problemText };

    await fetchSolutions(problemText, tempFilters);
  });

  displayOptions.forEach(opt =>
    opt.addEventListener("change", () => renderTickets(lastTickets))
  );

  async function fetchSolutions(problemText, filters) {

    if (/^\d+$/.test(problemText)) {
      const callId = problemText.replace(/,/g, "");
      await fetchCallIdDirect(callId);
      return;
    }

    try {
      const params = new URLSearchParams();
      params.append(
        "username",
        localStorage.getItem("loggedUser") || "Unknown"
      );

      function addFilter(key, value) {
        if (
          value !== undefined &&
          value !== null &&
          value.toString().trim() !== ""
        ) {
          params.append(key, value.trim());
        }
      }

      addFilter("fromDate", filters.fromDate);
      addFilter("toDate", filters.toDate);
      addFilter("bankName", filters.bankName);
      addFilter("problem", filters.problem);
      addFilter("ticketId", filters.ticketId);
      addFilter("product", filters.product);
      addFilter("program", filters.program);

      if (!problemText && [...params.entries()].length === 0) {
        solutionBox.innerHTML =
          `<p style="color:gray;">Please enter a problem or apply at least one filter.</p>`;
        return;
      }

      solutionBox.innerHTML = "<p>‚è≥ Searching... please wait.</p>";

      const API_BASE = "https://list-project-16.onrender.com";

      const response = await fetch(
        `${API_BASE}/api/tickets/search?${params.toString()}`,
        { method: "GET" }
      );

      if (!response.ok)
        throw new Error(`Server error: ${response.status}`);

      let tickets = await response.json();

      if (filters.problem) {
        const keywords = filters.problem.toLowerCase().split(" ");

        tickets = tickets.map(t => {
          let text =
            `${t.CALL_DETAILS || ""} ${t.SOLUTION_DETAILS || ""}`.toLowerCase();
          let score = 0;

          keywords.forEach(word => {
            if (text.includes(word)) score += 2;
            if (text.startsWith(word)) score += 3;
          });

          return { ...t, _score: score };
        });

        tickets = tickets
          .filter(t => t._score > 0)
          .sort((a, b) => b._score - a._score);

        if (tickets.length === 0) {
          solutionBox.innerHTML =
            `<p style="color:red;">‚ö†Ô∏è No similar results found.</p>`;
          lastTickets = [];
          return;
        }
      }

      lastTickets = tickets;
      renderTickets(lastTickets, filters.problem);

    } catch (err) {
      console.error("‚ùå Fetch Error:", err);
      solutionBox.innerHTML =
        `<p style="color:red;">‚ö†Ô∏è Could not connect to backend (port 8080).</p>`;
    }
  }

});

async function fetchTicketIdDirect(ticketId) {
  solutionBox.innerHTML = "<p>üîç Searching Ticket ID...</p>";

  try {
    const response = await fetch(
      `${API_BASE}/api/tickets/copy of supp_data - copy?TICKET_ID=${ticketId}`
    );

    if (!response.ok) throw new Error("Server error");

    const data = await response.json();

    if (!data || data.length === 0) {
      solutionBox.innerHTML =
        `<p style="color:red;">‚ùå No record found for Ticket ID: <b>${ticketId}</b></p>`;
      return;
    }

    lastTickets = data;
    renderTickets(data, `Ticket ID: ${ticketId}`);
    highlightFirstTicket();

  } catch (err) {
    solutionBox.innerHTML =
      `<p style="color:red;">‚ö† Unable to fetch record.</p>`;
    console.error(err);
  }
}

function renderTickets(tickets, problemText = "") {

  if (!tickets || tickets.length === 0) {
    solutionBox.innerHTML =
      `<p style="color:red;">No results found.</p>`;
    lastTickets = [];
    return;
  }

  const visibleFields = Array.from(displayOptions)
    .filter(opt => opt.checked)
    .map(opt => opt.value);

  let html = "";

  if (problemText) {
    html += `
      <h3>Search Results for:</h3>
      <p><b>${problemText}</b></p>
      <hr/>
    `;
  }

  html += `
    <table id="resultTable">
      <thead>
        <tr>
          <th>SR. NO</th>
          <th id="sortCallId">CALL_ID ‚¨ç</th>
          ${visibleFields.includes("date") ? "<th id='sortDate'>CALL_DATE ‚¨ç</th>" : ""}
          ${visibleFields.includes("bankName") ? "<th>BANK_NAME</th>" : ""}
          ${visibleFields.includes("product") ? "<th>PRODUCT</th>" : ""}
          ${visibleFields.includes("prodVersion") ? "<th>PROD_VERSION</th>" : ""}
          ${visibleFields.includes("program") ? "<th>PROGRAM</th>" : ""}
          ${visibleFields.includes("problem") ? "<th>CALL_DETAILS</th>" : ""}
          ${visibleFields.includes("solution") ? "<th>SOLUTION_DETAILS</th>" : ""}
          ${visibleFields.includes("queue") ? "<th>QUEUE</th>" : ""}
        </tr>
      </thead>
      <tbody>
  `;

  tickets.forEach((t, i) => {

    let callValue = (t.CALL_ID || t["√Ø¬ª¬øCALL_ID"] || "")
      .toString()
      .replace(/,/g, "");

    const callIdLink = callValue
      ? `<a class="call-link"
           href="http://172.100.30.3:8080/apex/f?p=100:90:0::NO::P90_CALLID:${callValue}"
           target="_blank"
           style="color:#007bff;font-weight:bold;text-decoration:underline;">
           ${callValue}
         </a>`
      : "-";

    let longProblem = t.CALL_DETAILS && t.CALL_DETAILS.length > 120;
    let longSolution = t.SOLUTION_DETAILS && t.SOLUTION_DETAILS.length > 120;

    html += `
      <tr class="ticket-row" id="ticket-${i}">
        <td>${i + 1}</td>
        <td>${callIdLink}</td>
        ${visibleFields.includes("date") ? `<td>${t.CALL_DATE || "-"}</td>` : ""}
        ${visibleFields.includes("bankName") ? `<td>${t.BANK_NAME || "-"}</td>` : ""}
        ${visibleFields.includes("product") ? `<td>${t.PRODUCT || "-"}</td>` : ""}
        ${visibleFields.includes("prodVersion") ? `<td>${t.PROD_VERSION || "-"}</td>` : ""}
        ${visibleFields.includes("program") ? `<td>${t.PROGRAM || "-"}</td>` : ""}

        ${visibleFields.includes("problem") ? `
          <td>
            <div class="clamp3">${makeLinksClickable(t.CALL_DETAILS || "-")}</div>
            ${longProblem ? `<span class="see-more-btn" onclick="toggleMore(this)">See More</span>` : ""}
          </td>` : ""}

        ${visibleFields.includes("solution") ? `
          <td>
            <div class="clamp3">${makeLinksClickable(t.SOLUTION_DETAILS || "-")}</div>
            ${longSolution ? `<span class="see-more-btn" onclick="toggleMore(this)">See More</span>` : ""}
          </td>` : ""}

        ${visibleFields.includes("queue") ? `<td>${t.QUEUE || "-"}</td>` : ""}
      </tr>
    `;
  });

  html += `</tbody></table>`;
  solutionBox.innerHTML = html;

  applySolutionFilter();
  enableRowHighlight();
}

window.toggleMore = function (btn) {
  const box = btn.previousElementSibling;

  if (!box) return;

  const isExpanded = box.classList.contains("expanded-text");

  if (isExpanded) {
    box.classList.remove("expanded-text");
    btn.innerText = "See More";
  } else {
    box.classList.add("expanded-text");
    btn.innerText = "See Less";
  }
};

function applySolutionFilter() {
  const showAll =
    document.getElementById("showShortSolutions").checked;

  const rows =
    document.querySelectorAll("#resultTable tbody tr");

  rows.forEach(row => {
    const solutionCell =
      row.querySelector("td:nth-last-child(2)");

    if (!solutionCell) return;

    const text = solutionCell.innerText.trim();
    const wordCount = text.split(/\s+/).length;

    if (!showAll && (text === "-" || text === "" || wordCount < 1)) {
      row.style.display = "none";
    } else {
      row.style.display = "";
    }
  });
}

document
  .getElementById("showShortSolutions")
  .addEventListener("change", () => {
    applySolutionFilter();
  });

let activeRowIndex = 0;

function enableRowHighlight() {
  const rows = document.querySelectorAll(".ticket-row");
  if (rows.length === 0) return;

  rows.forEach(r => r.classList.remove("ticket-active"));

  if (activeRowIndex < 0) activeRowIndex = 0;
  if (activeRowIndex >= rows.length)
    activeRowIndex = rows.length - 1;

  const activeRow = rows[activeRowIndex];
  activeRow.classList.add("ticket-active");

  if (!window.isSorting) {
    activeRow.scrollIntoView({
      behavior: "smooth",
      block: "center"
    });
  }

  rows.forEach((row, i) => {
    row.addEventListener("click", () => {
      activeRowIndex = i;
      enableRowHighlight();
    });
  });
}

function makeLinksClickable(text) {
  return text.replace(
    /(https?:\/\/[^\s]+)/g,
    '<a href="$1" target="_blank">$1</a>'
  );
}

// --------- KEYBOARD NAVIGATION (ARROWS + ENTER) ---------

document.addEventListener("keydown", (e) => {

  const rows = document.querySelectorAll(".ticket-row");
  if (rows.length === 0) return;

  switch (e.key) {

    case "ArrowDown":
      e.preventDefault();
      activeRowIndex = Math.min(activeRowIndex + 1, rows.length - 1);
      enableRowHighlight();
      break;

    case "ArrowUp":
      e.preventDefault();
      activeRowIndex = Math.max(activeRowIndex - 1, 0);
      enableRowHighlight();
      break;

    case "Enter":
      e.preventDefault();

      const row = rows[activeRowIndex];
      if (!row) break;

      const callLink = row.querySelector("a.call-link");
      if (callLink && callLink.href) {
        window.open(callLink.href, "_blank");
        break;
      }

      const cmsLink = row.querySelector("a.cms-link");
      if (cmsLink && cmsLink.href) {
        window.open(cmsLink.href, "_blank");
      }

      break;
  }
});


// --------- EXPORT CSV (EXCEL) ---------

function exportToCSV(filename = "solutions.csv") {

  if (!lastTickets || lastTickets.length === 0) {
    alert("No results to export.");
    return;
  }

  const visibleFields = Array.from(displayOptions)
    .filter(o => o.checked)
    .map(o => o.value);

  const cols = ["CALL_ID"];

  if (visibleFields.includes("date")) cols.push("CALL_DATE");
  if (visibleFields.includes("bankName")) cols.push("BANK_NAME");
  if (visibleFields.includes("product")) cols.push("PRODUCT");
  if (visibleFields.includes("prodVersion")) cols.push("PROD_VERSION");
  if (visibleFields.includes("program")) cols.push("PROGRAM");
  if (visibleFields.includes("queue")) cols.push("QUEUE");
  if (visibleFields.includes("problem")) cols.push("CALL_DETAILS");
  if (visibleFields.includes("solution")) cols.push("SOLUTION_DETAILS");

  const rows = lastTickets.map(t => {
    return cols.map(c => {
      const v =
        t[c] === undefined || t[c] === null
          ? ""
          : String(t[c]).replace(/,/g, " ");
      return `"${v.replace(/"/g, '""')}"`;
    }).join(",");
  });

  const csv = [cols.join(","), ...rows].join("\n");

  const blob = new Blob([csv], {
    type: "text/csv;charset=utf-8;"
  });

  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = filename;

  document.body.appendChild(a);
  a.click();
  a.remove();

  URL.revokeObjectURL(url);
}


// --------- EXPORT PDF (BROWSER PRINT) ---------

function exportToPDF() {

  if (!lastTickets || lastTickets.length === 0) {
    alert("No results to export.");
    return;
  }

  const visibleFields = Array.from(displayOptions)
    .filter(o => o.checked)
    .map(o => o.value);

  const cols = ["CALL_ID"];

  if (visibleFields.includes("date")) cols.push("CALL_DATE");
  if (visibleFields.includes("bankName")) cols.push("BANK_NAME");
  if (visibleFields.includes("product")) cols.push("PRODUCT");
  if (visibleFields.includes("prodVersion")) cols.push("PROD_VERSION");
  if (visibleFields.includes("program")) cols.push("PROGRAM");
  if (visibleFields.includes("queue")) cols.push("QUEUE");
  if (visibleFields.includes("problem")) cols.push("CALL_DETAILS");
  if (visibleFields.includes("solution")) cols.push("SOLUTION_DETAILS");

  let html = `
    <html>
      <head>
        <title>Solutions</title>
        <style>
          table {
            width: 100%;
            border-collapse: collapse;
            font-family: Arial, Helvetica, sans-serif;
          }
          th, td {
            border: 1px solid #ccc;
            padding: 8px;
            font-size: 12px;
            vertical-align: top;
          }
          th {
            background: #f0f0f0;
          }
        </style>
      </head>
      <body>
        <h3>Exported Solutions</h3>
        <table>
          <thead>
            <tr>
  `;

  cols.forEach(c => {
    html += `<th>${c}</th>`;
  });

  html += `
            </tr>
          </thead>
          <tbody>
  `;

  lastTickets.forEach(t => {
    html += "<tr>";
    cols.forEach(c => {
      const v =
        t[c] === undefined || t[c] === null
          ? ""
          : String(t[c])
              .replace(/</g, "&lt;")
              .replace(/>/g, "&gt;");
      html += `<td>${v}</td>`;
    });
    html += "</tr>";
  });

  html += `
          </tbody>
        </table>
      </body>
    </html>
  `;

  const w = window.open("", "_blank");
  w.document.open();
  w.document.write(html);
  w.document.close();
}


// --------- LOGIN PAGE JS ---------

document
  .getElementById("loginForm")
  .addEventListener("submit", function (e) {

    e.preventDefault();

    const user =
      document.getElementById("username").value.trim();

    const pass =
      document.getElementById("password").value.trim();

    if (user === "" || pass === "") {
      alert("Please enter username and password.");
      return;
    }

    localStorage.setItem("loggedUser", user);
    window.location.href = "home.html";
  });

</script>
